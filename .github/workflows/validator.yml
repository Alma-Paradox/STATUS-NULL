name: STATUS:NULL â€” Immediate Validator

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Extract Issue Body
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || "";

            function extractField(label) {
              const regex = new RegExp(`### ${label}\\n([\\s\\S]*?)(\\n###|$)`);
              const match = body.match(regex);
              return match ? match[1].trim() : "";
            }

            const url = extractField("URL");
            const data = extractField("DATA");
            const chapter = extractField("Chapter");

            core.setOutput("url", url);
            core.setOutput("data", data);
            core.setOutput("chapter", chapter);

      - name: Basic Validation
        id: validate
        uses: actions/github-script@v7
        with:
          script: |
            const url = `${{ steps.extract.outputs.url }}`;
            const data = `${{ steps.extract.outputs.data }}`;
            const chapter = `${{ steps.extract.outputs.chapter }}`;

            let valid = true;

            if (!url.startsWith("http")) valid = false;
            if (data.length === 0) valid = false;
            if (!/^\d+$/.test(chapter)) valid = false;

            core.setOutput("valid", valid.toString());

      - name: Apply Label
        uses: actions/github-script@v7
        with:
          script: |
            const valid = `${{ steps.validate.outputs.valid }}` === "true";
            const label = valid ? "valid" : "invalid";

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [label]
            });

      - name: Lock Issue (with retry)
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            const maxRetries = 3;

            for (let attempt = 1; attempt <= maxRetries; attempt++) {
              try {
                await github.rest.issues.lock({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number,
                  lock_reason: "resolved"
                });
                return;
              } catch (error) {
                if (attempt === maxRetries) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number,
                    labels: ["lock-failed"]
                  });

                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number,
                    state: "closed"
                  });

                  throw error;
                }
                await new Promise(res => setTimeout(res, 2 ** attempt * 1000));
              }
            }
